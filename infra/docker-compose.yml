services:
  postgres:
    image: postgres:17
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-fivecrowns}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      POSTGRES_DB: ${POSTGRES_DB:-fivecrowns}
    volumes:
      - pgdata:/var/lib/postgresql/data
    restart: unless-stopped

  server:
    image: dart:stable
    working_dir: /app
    volumes:
      - ../server:/app
      - ../packages:/packages
    command: ["sh", "-c", "dart pub get && dart run bin/server.dart"]
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-production}
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL must be set}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET must be set}
      JWT_ACCESS_TTL_DAYS: ${JWT_ACCESS_TTL_DAYS:-7}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:?ALLOWED_ORIGINS must be set}
      TRUST_PROXY: "true"
      # SMTP Configuration
      SMTP_HOST: ${SMTP_HOST:?SMTP_HOST must be set}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_FROM: ${SMTP_FROM:?SMTP_FROM must be set}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_SECURE: ${SMTP_SECURE:-true}
      BASE_URL: ${BASE_URL:?BASE_URL must be set}
      # LiveKit
      LIVEKIT_URL: ${LIVEKIT_URL:?LIVEKIT_URL must be set}
      LIVEKIT_API_KEY: ${LIVEKIT_API_KEY:?LIVEKIT_API_KEY must be set}
      LIVEKIT_API_SECRET: ${LIVEKIT_API_SECRET:?LIVEKIT_API_SECRET must be set}
    depends_on:
      - postgres
    restart: unless-stopped
    # No external ports - only accessible via Caddy

  livekit:
    image: livekit/livekit-server:latest
    command: --config /etc/livekit.yaml
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml:ro
    ports:
      # 7880 not exposed - proxied through Caddy
      - "7881:7881"      # WebRTC TCP
      - "7882:7882/udp"  # WebRTC UDP
    restart: unless-stopped

  coturn:
    image: coturn/coturn:latest
    command: ["-c", "/etc/turnserver.conf"]
    volumes:
      - ./turnserver.conf:/etc/turnserver.conf:ro
    ports:
      - "3478:3478"
      - "3478:3478/udp"
      - "5349:5349"
      - "5349:5349/udp"
    restart: unless-stopped

  caddy:
    image: caddy:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - server
      - livekit
    restart: unless-stopped

volumes:
  pgdata:
  caddy_data:
  caddy_config:
